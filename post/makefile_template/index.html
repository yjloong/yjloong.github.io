<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Makefile自动化模板 | HOME</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Features

灵活的工具链配置
智能的源文件管理
完善的构建目录隔离
多目标构建支持​
自动化与优化
典型应用场景: 嵌入式开发、小型项目

# 工具链配置
# 可通过环境变量覆盖，例如：`make COMPILER_PREFIX=arm-none-eabi-`
COMPILER_PREFIX :=
CC      := $(COMPILER_PREFIX)gcc          # C 编译器
OBJDUMP := $(COMPILER_PREFIX)objdump      # 反汇编工具
OBJCOPY := $(COMPILER_PREFIX)objcopy      # 二进制转换工具

# 构建输出目录
OUTPUT_DIR := output

# 源文件处理
SRCS := $(wildcard *.c *.S)              # 获取所有.c和.S文件
IGNS :=                                  # 需要忽略的文件列表（可扩展）
SRCS := $(filter-out $(IGNS),$(SRCS))    # 过滤掉忽略的文件
OBJS := $(foreach src,$(SRCS),$(addprefix $(OUTPUT_DIR)/,$(dir $(src))$(basename $(notdir $(src))).o))  # 生成对应的.o文件路径
DEPS := $(OBJS:.o=.d)                    # 生成依赖文件路径

# 目标配置
target := hello                          # 基础目标名称
target := $(target).elf                  # 完整目标名称（ELF格式）

# 编译选项
# 可添加的优化选项示例：
# -ffunction-sections -fdata-sections -Wl,gc-sections -finline-functions -finline-small-functions
CFLAGS  :=                               # C编译标志
LDFLAGS := -Wl,--cref,-Map=$(OUTPUT_DIR)/$(target:.elf=.map)  # 链接标志（生成map文件）
LDLIBS  :=                               # 链接库（例如：-lm 数学库）

# 头文件目录配置
INC_DIRS := ./ ./include                 # 包含目录列表
# 将目录转换为绝对路径并添加-I前缀
CFLAGS &#43;= $(foreach dr,$(INC_DIRS),-I$(abspath $(shell echo $(dr))))

# 自动启用并行编译（如果未指定-j参数）
ifeq (,$(findstring j,$(MAKEFLAGS)))
MAKEFLAGS &#43;= -j
endif

# 默认构建目标
all: $(target) $(target:.elf=.bin) $(target:.elf=.txt)

# 创建输出目录规则
$(OUTPUT_DIR):
mkdir -p $(OUTPUT_DIR)

# 主链接规则（生成ELF文件）
$(target): $(OBJS) | $(OUTPUT_DIR)
$(CC) $(CFLAGS) $(LDFLAGS) $(OBJS) $(LDLIBS) -o $@

# 特殊文件的额外编译选项（示例：main.o可以有不同的编译选项）
$(OUTPUT_DIR)/./main.o: EXTRA_CFLAGS :=

# 依赖文件生成标志
DEPFLAGS = -MMD -MP -MF $(@:.o=.d)

# C源文件编译规则
$(OUTPUT_DIR)/%.o: %.c Makefile | $(OUTPUT_DIR)
echo &#34;CC $&lt;&#34;
mkdir -p $(dir $@)
$(CC) $(CFLAGS) $(DEPFLAGS) $(EXTRA_CFLAGS) -c $&lt; -o $@

# 汇编文件编译规则
$(OUTPUT_DIR)/%.o: %.S Makefile | $(OUTPUT_DIR)
echo &#34;AS $&lt;&#34;
mkdir -p $(dir $@)
$(CC) $(CFLAGS) $(DEPFLAGS) $(EXTRA_CFLAGS) -c $&lt; -o $@

# 包含依赖文件
-include $(DEPS)

# 生成二进制文件规则
%.bin: %.elf
$(OBJCOPY) -S --set-section-flags .bss=alloc,contents -O binary $&lt; $@

# 生成反汇编文件规则
%.txt: %.elf
$(OBJDUMP) -d $&lt; &gt; $@

# 链接脚本预处理规则（示例）
%.ld: %.ld.s
cat $&lt; | $(CC) $(CFLAGS) -xc - | grep -v &#39;^#&#39; &gt; $@

# 新增功能：调试目标
debug: CFLAGS &#43;= -g -O0
debug: all

# 新增功能：发布目标（优化）
release: CFLAGS &#43;= -O2
release: all

# 新增功能：显示帮助信息
.PHONY: help
help:
@echo &#34;可用目标:&#34;
@echo &#34;  all       - 构建所有目标（默认）&#34;
@echo &#34;  debug     - 构建带调试信息的目标&#34;
@echo &#34;  release   - 构建优化后的目标&#34;
@echo &#34;  clean     - 清理构建文件&#34;
@echo &#34;  help      - 显示此帮助信息&#34;

# 清理规则
.PHONY: clean
clean:
rm -rf $(OUTPUT_DIR)

# 静默规则（不显示命令回显）
.SILENT:
">
    <meta name="generator" content="Hugo 0.147.9">
    
    
    
      <meta name="robots" content="index, follow">
    
    <meta name="author" content="yjloong">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.cd2c801248c2f81c7369ed96f333206cb56c7a83f356f5eed4b43a403c352549.css" >




    


    
      
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />


    

    

    
      <link rel="canonical" href="https://yjloong.github.io/post/makefile_template/">
    

    <meta property="og:url" content="https://yjloong.github.io/post/makefile_template/">
  <meta property="og:site_name" content="HOME">
  <meta property="og:title" content="Makefile自动化模板">
  <meta property="og:description" content="Features 灵活的工具链配置 智能的源文件管理 完善的构建目录隔离 多目标构建支持​ 自动化与优化 典型应用场景: 嵌入式开发、小型项目 # 工具链配置 # 可通过环境变量覆盖，例如：`make COMPILER_PREFIX=arm-none-eabi-` COMPILER_PREFIX := CC := $(COMPILER_PREFIX)gcc # C 编译器 OBJDUMP := $(COMPILER_PREFIX)objdump # 反汇编工具 OBJCOPY := $(COMPILER_PREFIX)objcopy # 二进制转换工具 # 构建输出目录 OUTPUT_DIR := output # 源文件处理 SRCS := $(wildcard *.c *.S) # 获取所有.c和.S文件 IGNS := # 需要忽略的文件列表（可扩展） SRCS := $(filter-out $(IGNS),$(SRCS)) # 过滤掉忽略的文件 OBJS := $(foreach src,$(SRCS),$(addprefix $(OUTPUT_DIR)/,$(dir $(src))$(basename $(notdir $(src))).o)) # 生成对应的.o文件路径 DEPS := $(OBJS:.o=.d) # 生成依赖文件路径 # 目标配置 target := hello # 基础目标名称 target := $(target).elf # 完整目标名称（ELF格式） # 编译选项 # 可添加的优化选项示例： # -ffunction-sections -fdata-sections -Wl,gc-sections -finline-functions -finline-small-functions CFLAGS := # C编译标志 LDFLAGS := -Wl,--cref,-Map=$(OUTPUT_DIR)/$(target:.elf=.map) # 链接标志（生成map文件） LDLIBS := # 链接库（例如：-lm 数学库） # 头文件目录配置 INC_DIRS := ./ ./include # 包含目录列表 # 将目录转换为绝对路径并添加-I前缀 CFLAGS &#43;= $(foreach dr,$(INC_DIRS),-I$(abspath $(shell echo $(dr)))) # 自动启用并行编译（如果未指定-j参数） ifeq (,$(findstring j,$(MAKEFLAGS))) MAKEFLAGS &#43;= -j endif # 默认构建目标 all: $(target) $(target:.elf=.bin) $(target:.elf=.txt) # 创建输出目录规则 $(OUTPUT_DIR): mkdir -p $(OUTPUT_DIR) # 主链接规则（生成ELF文件） $(target): $(OBJS) | $(OUTPUT_DIR) $(CC) $(CFLAGS) $(LDFLAGS) $(OBJS) $(LDLIBS) -o $@ # 特殊文件的额外编译选项（示例：main.o可以有不同的编译选项） $(OUTPUT_DIR)/./main.o: EXTRA_CFLAGS := # 依赖文件生成标志 DEPFLAGS = -MMD -MP -MF $(@:.o=.d) # C源文件编译规则 $(OUTPUT_DIR)/%.o: %.c Makefile | $(OUTPUT_DIR) echo &#34;CC $&lt;&#34; mkdir -p $(dir $@) $(CC) $(CFLAGS) $(DEPFLAGS) $(EXTRA_CFLAGS) -c $&lt; -o $@ # 汇编文件编译规则 $(OUTPUT_DIR)/%.o: %.S Makefile | $(OUTPUT_DIR) echo &#34;AS $&lt;&#34; mkdir -p $(dir $@) $(CC) $(CFLAGS) $(DEPFLAGS) $(EXTRA_CFLAGS) -c $&lt; -o $@ # 包含依赖文件 -include $(DEPS) # 生成二进制文件规则 %.bin: %.elf $(OBJCOPY) -S --set-section-flags .bss=alloc,contents -O binary $&lt; $@ # 生成反汇编文件规则 %.txt: %.elf $(OBJDUMP) -d $&lt; &gt; $@ # 链接脚本预处理规则（示例） %.ld: %.ld.s cat $&lt; | $(CC) $(CFLAGS) -xc - | grep -v &#39;^#&#39; &gt; $@ # 新增功能：调试目标 debug: CFLAGS &#43;= -g -O0 debug: all # 新增功能：发布目标（优化） release: CFLAGS &#43;= -O2 release: all # 新增功能：显示帮助信息 .PHONY: help help: @echo &#34;可用目标:&#34; @echo &#34; all - 构建所有目标（默认）&#34; @echo &#34; debug - 构建带调试信息的目标&#34; @echo &#34; release - 构建优化后的目标&#34; @echo &#34; clean - 清理构建文件&#34; @echo &#34; help - 显示此帮助信息&#34; # 清理规则 .PHONY: clean clean: rm -rf $(OUTPUT_DIR) # 静默规则（不显示命令回显） .SILENT:">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2025-07-06T11:28:53+00:00">
    <meta property="article:modified_time" content="2025-07-06T11:28:53+00:00">
    <meta property="article:tag" content="Makefile">

  <meta itemprop="name" content="Makefile自动化模板">
  <meta itemprop="description" content="Features 灵活的工具链配置 智能的源文件管理 完善的构建目录隔离 多目标构建支持​ 自动化与优化 典型应用场景: 嵌入式开发、小型项目 # 工具链配置 # 可通过环境变量覆盖，例如：`make COMPILER_PREFIX=arm-none-eabi-` COMPILER_PREFIX := CC := $(COMPILER_PREFIX)gcc # C 编译器 OBJDUMP := $(COMPILER_PREFIX)objdump # 反汇编工具 OBJCOPY := $(COMPILER_PREFIX)objcopy # 二进制转换工具 # 构建输出目录 OUTPUT_DIR := output # 源文件处理 SRCS := $(wildcard *.c *.S) # 获取所有.c和.S文件 IGNS := # 需要忽略的文件列表（可扩展） SRCS := $(filter-out $(IGNS),$(SRCS)) # 过滤掉忽略的文件 OBJS := $(foreach src,$(SRCS),$(addprefix $(OUTPUT_DIR)/,$(dir $(src))$(basename $(notdir $(src))).o)) # 生成对应的.o文件路径 DEPS := $(OBJS:.o=.d) # 生成依赖文件路径 # 目标配置 target := hello # 基础目标名称 target := $(target).elf # 完整目标名称（ELF格式） # 编译选项 # 可添加的优化选项示例： # -ffunction-sections -fdata-sections -Wl,gc-sections -finline-functions -finline-small-functions CFLAGS := # C编译标志 LDFLAGS := -Wl,--cref,-Map=$(OUTPUT_DIR)/$(target:.elf=.map) # 链接标志（生成map文件） LDLIBS := # 链接库（例如：-lm 数学库） # 头文件目录配置 INC_DIRS := ./ ./include # 包含目录列表 # 将目录转换为绝对路径并添加-I前缀 CFLAGS &#43;= $(foreach dr,$(INC_DIRS),-I$(abspath $(shell echo $(dr)))) # 自动启用并行编译（如果未指定-j参数） ifeq (,$(findstring j,$(MAKEFLAGS))) MAKEFLAGS &#43;= -j endif # 默认构建目标 all: $(target) $(target:.elf=.bin) $(target:.elf=.txt) # 创建输出目录规则 $(OUTPUT_DIR): mkdir -p $(OUTPUT_DIR) # 主链接规则（生成ELF文件） $(target): $(OBJS) | $(OUTPUT_DIR) $(CC) $(CFLAGS) $(LDFLAGS) $(OBJS) $(LDLIBS) -o $@ # 特殊文件的额外编译选项（示例：main.o可以有不同的编译选项） $(OUTPUT_DIR)/./main.o: EXTRA_CFLAGS := # 依赖文件生成标志 DEPFLAGS = -MMD -MP -MF $(@:.o=.d) # C源文件编译规则 $(OUTPUT_DIR)/%.o: %.c Makefile | $(OUTPUT_DIR) echo &#34;CC $&lt;&#34; mkdir -p $(dir $@) $(CC) $(CFLAGS) $(DEPFLAGS) $(EXTRA_CFLAGS) -c $&lt; -o $@ # 汇编文件编译规则 $(OUTPUT_DIR)/%.o: %.S Makefile | $(OUTPUT_DIR) echo &#34;AS $&lt;&#34; mkdir -p $(dir $@) $(CC) $(CFLAGS) $(DEPFLAGS) $(EXTRA_CFLAGS) -c $&lt; -o $@ # 包含依赖文件 -include $(DEPS) # 生成二进制文件规则 %.bin: %.elf $(OBJCOPY) -S --set-section-flags .bss=alloc,contents -O binary $&lt; $@ # 生成反汇编文件规则 %.txt: %.elf $(OBJDUMP) -d $&lt; &gt; $@ # 链接脚本预处理规则（示例） %.ld: %.ld.s cat $&lt; | $(CC) $(CFLAGS) -xc - | grep -v &#39;^#&#39; &gt; $@ # 新增功能：调试目标 debug: CFLAGS &#43;= -g -O0 debug: all # 新增功能：发布目标（优化） release: CFLAGS &#43;= -O2 release: all # 新增功能：显示帮助信息 .PHONY: help help: @echo &#34;可用目标:&#34; @echo &#34; all - 构建所有目标（默认）&#34; @echo &#34; debug - 构建带调试信息的目标&#34; @echo &#34; release - 构建优化后的目标&#34; @echo &#34; clean - 清理构建文件&#34; @echo &#34; help - 显示此帮助信息&#34; # 清理规则 .PHONY: clean clean: rm -rf $(OUTPUT_DIR) # 静默规则（不显示命令回显） .SILENT:">
  <meta itemprop="datePublished" content="2025-07-06T11:28:53+00:00">
  <meta itemprop="dateModified" content="2025-07-06T11:28:53+00:00">
  <meta itemprop="wordCount" content="316">
  <meta itemprop="keywords" content="Makefile">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Makefile自动化模板">
  <meta name="twitter:description" content="Features 灵活的工具链配置 智能的源文件管理 完善的构建目录隔离 多目标构建支持​ 自动化与优化 典型应用场景: 嵌入式开发、小型项目 # 工具链配置 # 可通过环境变量覆盖，例如：`make COMPILER_PREFIX=arm-none-eabi-` COMPILER_PREFIX := CC := $(COMPILER_PREFIX)gcc # C 编译器 OBJDUMP := $(COMPILER_PREFIX)objdump # 反汇编工具 OBJCOPY := $(COMPILER_PREFIX)objcopy # 二进制转换工具 # 构建输出目录 OUTPUT_DIR := output # 源文件处理 SRCS := $(wildcard *.c *.S) # 获取所有.c和.S文件 IGNS := # 需要忽略的文件列表（可扩展） SRCS := $(filter-out $(IGNS),$(SRCS)) # 过滤掉忽略的文件 OBJS := $(foreach src,$(SRCS),$(addprefix $(OUTPUT_DIR)/,$(dir $(src))$(basename $(notdir $(src))).o)) # 生成对应的.o文件路径 DEPS := $(OBJS:.o=.d) # 生成依赖文件路径 # 目标配置 target := hello # 基础目标名称 target := $(target).elf # 完整目标名称（ELF格式） # 编译选项 # 可添加的优化选项示例： # -ffunction-sections -fdata-sections -Wl,gc-sections -finline-functions -finline-small-functions CFLAGS := # C编译标志 LDFLAGS := -Wl,--cref,-Map=$(OUTPUT_DIR)/$(target:.elf=.map) # 链接标志（生成map文件） LDLIBS := # 链接库（例如：-lm 数学库） # 头文件目录配置 INC_DIRS := ./ ./include # 包含目录列表 # 将目录转换为绝对路径并添加-I前缀 CFLAGS &#43;= $(foreach dr,$(INC_DIRS),-I$(abspath $(shell echo $(dr)))) # 自动启用并行编译（如果未指定-j参数） ifeq (,$(findstring j,$(MAKEFLAGS))) MAKEFLAGS &#43;= -j endif # 默认构建目标 all: $(target) $(target:.elf=.bin) $(target:.elf=.txt) # 创建输出目录规则 $(OUTPUT_DIR): mkdir -p $(OUTPUT_DIR) # 主链接规则（生成ELF文件） $(target): $(OBJS) | $(OUTPUT_DIR) $(CC) $(CFLAGS) $(LDFLAGS) $(OBJS) $(LDLIBS) -o $@ # 特殊文件的额外编译选项（示例：main.o可以有不同的编译选项） $(OUTPUT_DIR)/./main.o: EXTRA_CFLAGS := # 依赖文件生成标志 DEPFLAGS = -MMD -MP -MF $(@:.o=.d) # C源文件编译规则 $(OUTPUT_DIR)/%.o: %.c Makefile | $(OUTPUT_DIR) echo &#34;CC $&lt;&#34; mkdir -p $(dir $@) $(CC) $(CFLAGS) $(DEPFLAGS) $(EXTRA_CFLAGS) -c $&lt; -o $@ # 汇编文件编译规则 $(OUTPUT_DIR)/%.o: %.S Makefile | $(OUTPUT_DIR) echo &#34;AS $&lt;&#34; mkdir -p $(dir $@) $(CC) $(CFLAGS) $(DEPFLAGS) $(EXTRA_CFLAGS) -c $&lt; -o $@ # 包含依赖文件 -include $(DEPS) # 生成二进制文件规则 %.bin: %.elf $(OBJCOPY) -S --set-section-flags .bss=alloc,contents -O binary $&lt; $@ # 生成反汇编文件规则 %.txt: %.elf $(OBJDUMP) -d $&lt; &gt; $@ # 链接脚本预处理规则（示例） %.ld: %.ld.s cat $&lt; | $(CC) $(CFLAGS) -xc - | grep -v &#39;^#&#39; &gt; $@ # 新增功能：调试目标 debug: CFLAGS &#43;= -g -O0 debug: all # 新增功能：发布目标（优化） release: CFLAGS &#43;= -O2 release: all # 新增功能：显示帮助信息 .PHONY: help help: @echo &#34;可用目标:&#34; @echo &#34; all - 构建所有目标（默认）&#34; @echo &#34; debug - 构建带调试信息的目标&#34; @echo &#34; release - 构建优化后的目标&#34; @echo &#34; clean - 清理构建文件&#34; @echo &#34; help - 显示此帮助信息&#34; # 清理规则 .PHONY: clean clean: rm -rf $(OUTPUT_DIR) # 静默规则（不显示命令回显） .SILENT:">

      
    
	
  </head><body class="ma0 avenir bg-near-white production">

    
   
  

  
  
  
  <header class="cover bg-center" style="background-image: url('https://yjloong.github.io/images/bg01.JPG');">
    <div class="bg-black-60">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        HOME
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/about/" title="About 页">
              About
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/tags" title="Tags 页">
              Tags
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/post/" title="Articles 页">
              Articles
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/contact/" title="Contact 页">
              Contact
            </a>
          </li>
          
        </ul>
      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

      <div class="tc-l pv6 ph3 ph4-ns">
        
      </div>
    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Makefile自动化模板</h1>
      
      <p class="tracked"><strong>yjloong</strong>
      </p>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2025-07-06T11:28:53Z">七月 6, 2025</time>
      

      
      
        <span class="f6 mv4 dib tracked"> -  </span>
        <span class="f6 mv4 dib tracked"> -  </span>
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h1 id="features">Features</h1>
<ul>
<li><strong>灵活的工具链配置</strong></li>
<li><strong>智能的源文件管理</strong></li>
<li><strong>完善的构建目录隔离</strong></li>
<li><strong>多目标构建支持​</strong></li>
<li><strong>自动化与优化</strong></li>
<li><strong>典型应用场景</strong>: 嵌入式开发、小型项目</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span><span style="color:#75715e"># 工具链配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># 可通过环境变量覆盖，例如：`make COMPILER_PREFIX=arm-none-eabi-`
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>COMPILER_PREFIX <span style="color:#f92672">:=</span>
</span></span><span style="display:flex;"><span>CC      <span style="color:#f92672">:=</span> <span style="color:#66d9ef">$(</span>COMPILER_PREFIX<span style="color:#66d9ef">)</span>gcc          <span style="color:#75715e"># C 编译器</span>
</span></span><span style="display:flex;"><span>OBJDUMP <span style="color:#f92672">:=</span> <span style="color:#66d9ef">$(</span>COMPILER_PREFIX<span style="color:#66d9ef">)</span>objdump      <span style="color:#75715e"># 反汇编工具</span>
</span></span><span style="display:flex;"><span>OBJCOPY <span style="color:#f92672">:=</span> <span style="color:#66d9ef">$(</span>COMPILER_PREFIX<span style="color:#66d9ef">)</span>objcopy      <span style="color:#75715e"># 二进制转换工具</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 构建输出目录
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>OUTPUT_DIR <span style="color:#f92672">:=</span> output
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 源文件处理
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SRCS <span style="color:#f92672">:=</span> <span style="color:#66d9ef">$(</span>wildcard *.c *.S<span style="color:#66d9ef">)</span>              <span style="color:#75715e"># 获取所有.c和.S文件</span>
</span></span><span style="display:flex;"><span>IGNS <span style="color:#f92672">:=</span>                                  <span style="color:#75715e"># 需要忽略的文件列表（可扩展）</span>
</span></span><span style="display:flex;"><span>SRCS <span style="color:#f92672">:=</span> <span style="color:#66d9ef">$(</span>filter-out <span style="color:#66d9ef">$(</span>IGNS<span style="color:#66d9ef">)</span>,<span style="color:#66d9ef">$(</span>SRCS<span style="color:#66d9ef">))</span>    <span style="color:#75715e"># 过滤掉忽略的文件</span>
</span></span><span style="display:flex;"><span>OBJS <span style="color:#f92672">:=</span> <span style="color:#66d9ef">$(</span>foreach src,<span style="color:#66d9ef">$(</span>SRCS<span style="color:#66d9ef">)</span>,<span style="color:#66d9ef">$(</span>addprefix <span style="color:#66d9ef">$(</span>OUTPUT_DIR<span style="color:#66d9ef">)</span>/,<span style="color:#66d9ef">$(</span>dir <span style="color:#66d9ef">$(</span>src<span style="color:#66d9ef">))$(</span>basename <span style="color:#66d9ef">$(</span>notdir <span style="color:#66d9ef">$(</span>src<span style="color:#66d9ef">)))</span>.o<span style="color:#66d9ef">))</span>  <span style="color:#75715e"># 生成对应的.o文件路径</span>
</span></span><span style="display:flex;"><span>DEPS <span style="color:#f92672">:=</span> <span style="color:#66d9ef">$(</span>OBJS:.o<span style="color:#f92672">=</span>.d<span style="color:#66d9ef">)</span>                    <span style="color:#75715e"># 生成依赖文件路径</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 目标配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>target <span style="color:#f92672">:=</span> hello                          <span style="color:#75715e"># 基础目标名称</span>
</span></span><span style="display:flex;"><span>target <span style="color:#f92672">:=</span> <span style="color:#66d9ef">$(</span>target<span style="color:#66d9ef">)</span>.elf                  <span style="color:#75715e"># 完整目标名称（ELF格式）</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 编译选项
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># 可添加的优化选项示例：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># -ffunction-sections -fdata-sections -Wl,gc-sections -finline-functions -finline-small-functions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>CFLAGS  <span style="color:#f92672">:=</span>                               <span style="color:#75715e"># C编译标志</span>
</span></span><span style="display:flex;"><span>LDFLAGS <span style="color:#f92672">:=</span> -Wl,--cref,-Map<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>OUTPUT_DIR<span style="color:#66d9ef">)</span>/<span style="color:#66d9ef">$(</span>target:.elf<span style="color:#f92672">=</span>.map<span style="color:#66d9ef">)</span>  <span style="color:#75715e"># 链接标志（生成map文件）</span>
</span></span><span style="display:flex;"><span>LDLIBS  <span style="color:#f92672">:=</span>                               <span style="color:#75715e"># 链接库（例如：-lm 数学库）</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 头文件目录配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>INC_DIRS <span style="color:#f92672">:=</span> ./ ./include                 <span style="color:#75715e"># 包含目录列表</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 将目录转换为绝对路径并添加-I前缀
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>CFLAGS <span style="color:#f92672">+=</span> <span style="color:#66d9ef">$(</span>foreach dr,<span style="color:#66d9ef">$(</span>INC_DIRS<span style="color:#66d9ef">)</span>,-I<span style="color:#66d9ef">$(</span>abspath <span style="color:#66d9ef">$(</span>shell echo <span style="color:#66d9ef">$(</span>dr<span style="color:#66d9ef">))))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 自动启用并行编译（如果未指定-j参数）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">ifeq</span> <span style="color:#960050;background-color:#1e0010">(,</span><span style="color:#66d9ef">$(</span>findstring j,<span style="color:#66d9ef">$(</span>MAKEFLAGS<span style="color:#66d9ef">))</span><span style="color:#960050;background-color:#1e0010">)</span>
</span></span><span style="display:flex;"><span>MAKEFLAGS <span style="color:#f92672">+=</span> -j
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">endif</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 默认构建目标
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">all</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">$(</span>target<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>target:.elf=.bin<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>target:.elf=.txt<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建输出目录规则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">$(OUTPUT_DIR)</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">mkdir</span> <span style="color:#960050;background-color:#1e0010">-p</span> <span style="color:#66d9ef">$(</span>OUTPUT_DIR<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 主链接规则（生成ELF文件）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">$(target)</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">$(</span>OBJS<span style="color:#66d9ef">)</span> | <span style="color:#66d9ef">$(</span>OUTPUT_DIR<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">$(</span>CC<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>CFLAGS<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>LDFLAGS<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>OBJS<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>LDLIBS<span style="color:#66d9ef">)</span> <span style="color:#960050;background-color:#1e0010">-o</span> <span style="color:#66d9ef">$@</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 特殊文件的额外编译选项（示例：main.o可以有不同的编译选项）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">$(OUTPUT_DIR)/./main.o</span><span style="color:#f92672">:</span> EXTRA_CFLAGS :=
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 依赖文件生成标志
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>DEPFLAGS <span style="color:#f92672">=</span> -MMD -MP -MF <span style="color:#66d9ef">$(</span>@:.o<span style="color:#f92672">=</span>.d<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># C源文件编译规则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">$(OUTPUT_DIR)/%.o</span><span style="color:#f92672">:</span> %.c Makefile | <span style="color:#66d9ef">$(</span>OUTPUT_DIR<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">echo</span> <span style="color:#e6db74">&#34;CC $&lt;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">mkdir</span> <span style="color:#960050;background-color:#1e0010">-p</span> <span style="color:#66d9ef">$(</span>dir <span style="color:#66d9ef">$</span>@<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">$(</span>CC<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>CFLAGS<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>DEPFLAGS<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>EXTRA_CFLAGS<span style="color:#66d9ef">)</span> <span style="color:#960050;background-color:#1e0010">-c</span> <span style="color:#66d9ef">$&lt;</span> <span style="color:#960050;background-color:#1e0010">-o</span> <span style="color:#66d9ef">$@</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 汇编文件编译规则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">$(OUTPUT_DIR)/%.o</span><span style="color:#f92672">:</span> %.S Makefile | <span style="color:#66d9ef">$(</span>OUTPUT_DIR<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">echo</span> <span style="color:#e6db74">&#34;AS $&lt;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">mkdir</span> <span style="color:#960050;background-color:#1e0010">-p</span> <span style="color:#66d9ef">$(</span>dir <span style="color:#66d9ef">$</span>@<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">$(</span>CC<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>CFLAGS<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>DEPFLAGS<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>EXTRA_CFLAGS<span style="color:#66d9ef">)</span> <span style="color:#960050;background-color:#1e0010">-c</span> <span style="color:#66d9ef">$&lt;</span> <span style="color:#960050;background-color:#1e0010">-o</span> <span style="color:#66d9ef">$@</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 包含依赖文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">-include</span> <span style="color:#66d9ef">$(</span>DEPS<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成二进制文件规则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">%.bin</span><span style="color:#f92672">:</span> %.elf
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">$(</span>OBJCOPY<span style="color:#66d9ef">)</span> <span style="color:#960050;background-color:#1e0010">-S</span> <span style="color:#960050;background-color:#1e0010">--set-section-flags</span> .bss<span style="color:#f92672">=</span>alloc,contents -O binary $&lt; $@
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 生成反汇编文件规则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">%.txt</span><span style="color:#f92672">:</span> %.elf
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">$(</span>OBJDUMP<span style="color:#66d9ef">)</span> <span style="color:#960050;background-color:#1e0010">-d</span> <span style="color:#66d9ef">$&lt;</span> <span style="color:#960050;background-color:#1e0010">&gt;</span> <span style="color:#66d9ef">$@</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 链接脚本预处理规则（示例）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">%.ld</span><span style="color:#f92672">:</span> %.ld.s
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">cat</span> <span style="color:#66d9ef">$&lt;</span> <span style="color:#960050;background-color:#1e0010">|</span> <span style="color:#66d9ef">$(</span>CC<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>CFLAGS<span style="color:#66d9ef">)</span> <span style="color:#960050;background-color:#1e0010">-xc</span> <span style="color:#960050;background-color:#1e0010">-</span> <span style="color:#960050;background-color:#1e0010">|</span> <span style="color:#960050;background-color:#1e0010">grep</span> <span style="color:#960050;background-color:#1e0010">-v</span> <span style="color:#e6db74">&#39;^#&#39;</span> <span style="color:#960050;background-color:#1e0010">&gt;</span> <span style="color:#66d9ef">$@</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 新增功能：调试目标
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">debug</span><span style="color:#f92672">:</span> CFLAGS += -g -O0
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">debug</span><span style="color:#f92672">:</span> all
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 新增功能：发布目标（优化）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">release</span><span style="color:#f92672">:</span> CFLAGS += -O2
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">release</span><span style="color:#f92672">:</span> all
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 新增功能：显示帮助信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> help
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">help</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@echo &#34;可用目标</span><span style="color:#f92672">:</span>&#34;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@echo</span> <span style="color:#e6db74">&#34;  all       - 构建所有目标（默认）&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@echo</span> <span style="color:#e6db74">&#34;  debug     - 构建带调试信息的目标&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@echo</span> <span style="color:#e6db74">&#34;  release   - 构建优化后的目标&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@echo</span> <span style="color:#e6db74">&#34;  clean     - 清理构建文件&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@echo</span> <span style="color:#e6db74">&#34;  help      - 显示此帮助信息&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 清理规则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> clean
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">clean</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">rm</span> <span style="color:#960050;background-color:#1e0010">-rf</span> <span style="color:#66d9ef">$(</span>OUTPUT_DIR<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 静默规则（不显示命令回显）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">.SILENT</span><span style="color:#f92672">:</span>
</span></span></code></pre></div><ul class="pa0">
  
   <li class="list di">
     <a href="/tags/makefile/" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Makefile</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://yjloong.github.io/" >
    &copy;  HOME 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
